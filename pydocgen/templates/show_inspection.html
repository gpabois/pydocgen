{% extends "base.html" %}

{% block content %}
<div class="content container">
    <h1>{{inspection.nom}} du {{inspection.date.strftime("%d/%m/%Y")}} de {{inspection.aiot.nom}}</h1>
    <a href={{url_for('create_insp_controle', inspection_id=inspection.id)}}>Créer point de contrôle</a>
    <a href={{url_for('edit_inspection', id=inspection.id)}}>Modifier</a>
    <a href={{url_for('generate_inspection_be_exploitant', id=inspection.id)}}>Générer BE Exploitant</a>
    <a href={{url_for('generate_inspection_rapport', id=inspection.id)}}>Générer rapport</a>
    

    <p>
    Rédacteur: {{inspection.redacteur.fullname()}}
    {% if inspection.approbateur == inspection.verificateur %}
        Vérificateur/Approbateur: {{inspection.verificateur.fullname()}}
    {% else %}
    {% endif %}
    </p>
    <h1>Propositions à l'issue de la visite</h1>

    <h1>Synthèse des constats</h1>
    {% if inspection.demandes_exploitant() %}
        <p>
            Il est demandé à l'exploitant de:
                <ul>
                {% for demande in inspection.demandes_exploitant() %}
                    <li>{{demande}}</li>
                {% endfor %}
                </ul>
        </p>
        <p>En l'absence de réponses, l'exploitant est susceptible d'être mis en demeure.</p>
    {% endif %}

    {% if inspection.controles %}
        {% for ctrl_nb, controle in enumerate(inspection.controles) %}
            <hr/>
            <h1>Point de contrôle n°{{ ctrl_nb + 1 }} - {{ controle.sous_theme }}</h1>
            <p>{{ controle.source }}{% if controle.date_source.strftime("%d/%m/%Y") %} du {{controle.date_source}}{% endif %}, {{controle.article_source}}</p>
            <a href={{url_for("edit_insp_controle", id=controle.id)}}>Modifier</a>
            <a href={{url_for("delete_insp_controle", id=controle.id)}}>Supprimer</a>
            <h3>Prescription</h3>
            <p>{{ controle.prescription | nl2br }}</p>
            <h3>Constats</h3>
            <p>{{ controle.constats | nl2br }}</p>

            <h4>Demandes à l'exploitant</h4>
            <a href={{url_for('create_insp_ctrl_demande_exploitant', ctrl_id=controle.id)}}>Créer demande à l'exploitant</a>
            {% if controle.demandes_exploitant() %}
                <p>
                Il est demandé à l'exploitant de:
                    <ul>
                    {% for demande in controle.demandes_exploitant() %}
                        <li>{{demande}} <a href={{url_for('delete_demande_exploitant', id=demande.id, next=url_for('show_inspection', id=inspection.id))}}>[Supprimer]</a></li>
                    {% endfor %}
                    </ul>
                </p>
            {% endif %}
        {% endfor %}
    {% endif %}
</div>
{% endblock %}